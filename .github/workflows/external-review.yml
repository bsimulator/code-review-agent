name: External PR Review Agent

on:
  workflow_dispatch:
    inputs:
      repo_owner:
        description: 'Repository owner (e.g., bsimulator)'
        required: true
        default: 'bsimulator'
      repo_name:
        description: 'Repository name (e.g., test-java-react-app)'
        required: true
        default: 'test-java-react-app'
      pr_number:
        description: 'Pull request number'
        required: true
        type: number

permissions:
  contents: read

jobs:
  review-external-pr:
    runs-on: ubuntu-latest
    name: Review External PR

    steps:
      - name: Checkout review agent
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repo_owner }}/${{ inputs.repo_name }}
          path: target-repo
          fetch-depth: 0

      - name: Get PR information
        id: pr-info
        working-directory: target-repo
        run: |
          # Get PR details using GitHub API
          PR_DATA=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ inputs.repo_owner }}/${{ inputs.repo_name }}/pulls/${{ inputs.pr_number }}")
          
          BASE_REF=$(echo "$PR_DATA" | jq -r '.base.ref')
          HEAD_SHA=$(echo "$PR_DATA" | jq -r '.head.sha')
          BASE_SHA=$(echo "$PR_DATA" | jq -r '.base.sha')
          
          echo "base_ref=$BASE_REF" >> $GITHUB_OUTPUT
          echo "head_sha=$HEAD_SHA" >> $GITHUB_OUTPUT
          echo "base_sha=$BASE_SHA" >> $GITHUB_OUTPUT
          
          echo "Base: $BASE_REF ($BASE_SHA)"
          echo "Head: $HEAD_SHA"

      - name: Generate PR diff
        working-directory: target-repo
        run: |
          git fetch origin ${{ steps.pr-info.outputs.base_ref }}
          git diff ${{ steps.pr-info.outputs.base_sha }}..${{ steps.pr-info.outputs.head_sha }} > ../pr_diff.txt
          echo "Diff generated, lines:"
          wc -l ../pr_diff.txt
          echo "Preview:"
          head -20 ../pr_diff.txt

      - name: Run Code Analyzer
        run: |
          if [ -s pr_diff.txt ]; then
            node analyzer.js pr_diff.txt > analysis_result.txt
            echo "Analysis completed"
            cat analysis_result.txt
          else
            echo "No diff found!"
            exit 1
          fi

      - name: Post Review Comment
        run: |
          REVIEW_BODY=$(cat analysis_result.txt)
          
          # Escape quotes and newlines for JSON
          REVIEW_JSON=$(echo "$REVIEW_BODY" | jq -Rs .)
          
          # Post comment using GitHub API
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"body\": $REVIEW_JSON}" \
            "https://api.github.com/repos/${{ inputs.repo_owner }}/${{ inputs.repo_name }}/issues/${{ inputs.pr_number }}/comments"
          
          echo "Review posted successfully!"
